helmDefaults:
  wait: true
  timeout: 600

repositories:
 - name: toposware
   url: https://raw.githubusercontent.com/toposware/helm-charts/gh-pages/
   username: {{ requiredEnv "GITHUB_USERNAME"}}
   password: {{ requiredEnv "GITHUB_TOKEN"}}
 - name: aws-efs-csi-driver
   url: https://kubernetes-sigs.github.io/aws-efs-csi-driver

releases:
- name: aws-efs-csi-driver
  namespace: kube-system
  chart: aws-efs-csi-driver/aws-efs-csi-driver
  version: 2.3.6
  createNamespace: true
  set:
  - name: controller.serviceAccount.annotations.eks\.amazonaws\.com/role-arn
    value: {{ requiredEnv "EKS_EFS_CSI_IRSA_ARN" }}

- name: tce-tmp-storage
  namespace: default
  chart: toposware/tce-tmp-storage
  version: 0.1.0
  createNamespace: true
  needs:
  - kube-system/aws-efs-csi-driver
  set:
  - name: fileSystemId
    value: {{ requiredEnv "FILESYSTEM_ID" }}

# Boot node
- name: boot
  namespace: default
  chart: toposware/tce-all-in-one
  version: 0.1.29
  createNamespace: true
  needs:
  - tce-tmp-storage
  set:
  - name: mode
    value: boot
  - name: replicas
    value: 1
  - name: certSpammer
    value: false
  - name: image.repository
    value: ghcr.io/toposware/topos
  - name: image.tag
    value: {{ requiredEnv "DOCKER_TAG"}}
  - name: credentials.username
    value: {{ requiredEnv "DOCKER_USERNAME"}}
  - name: credentials.password
    value: {{ requiredEnv "DOCKER_PASSWORD"}}
  - name: ingress
    value: false
  - name: env.TCE_JAEGER_SERVICE_NAME
    value: k8s-e2e-tce-boot-node
  - name: env.TCE_JAEGER_AGENT
    value: https://otel-collector.telemetry.devnet-1.toposware.com:443

# Peer nodes
- name: peer
  namespace: default
  chart: toposware/tce-all-in-one
  version: 0.1.29
  createNamespace: true
  needs:
  - boot
  set:
  - name: mode
    value: peer
  - name: replicas
    value: 15
  - name: certSpammer
    value: true
  - name: image.repository
    value: ghcr.io/toposware/topos
  - name: image.tag
    value: {{ requiredEnv "DOCKER_TAG"}}
  - name: credentials.username
    value: {{ requiredEnv "DOCKER_USERNAME"}}
  - name: credentials.password
    value: {{ requiredEnv "DOCKER_PASSWORD"}}
  - name: ingress
    value: false
  - name: env.TCE_JAEGER_SERVICE_NAME
    value: k8s-e2e-tce-boot-node
  - name: env.TCE_JAEGER_AGENT
    value: https://otel-collector.telemetry.devnet-1.toposware.com:443
